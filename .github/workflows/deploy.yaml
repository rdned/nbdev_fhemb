name: Deploy to GitHub Pages

permissions:
  contents: write

on:
  push:
    branches: ["main", "master"]
  workflow_dispatch:

jobs:
  build_and_deploy:
    runs-on: scienziatiello

    steps:
      - name: Clean workspace
        run: |
          set +e
          cd $GITHUB_WORKSPACE
          sudo git clean -ffdx 2>/dev/null
          sudo git reset --hard 2>/dev/null
          sudo rm -rf .git 2>/dev/null
          cd ..
          sudo rm -rf "$GITHUB_WORKSPACE" 2>/dev/null
          mkdir -p "$GITHUB_WORKSPACE"
          sudo chown -R $USER:$USER "$GITHUB_WORKSPACE"
          set -e

      - uses: actions/checkout@v4

      - name: Run nbdev build with debug
        env:
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          FHEMB_CI: ${{ secrets.FHEMB_CI }}
          FHEMB_SSH_KEY: ${{ secrets.FHEMB_SSH_KEY }}
          FHEMB_SSH_USER: ${{ secrets.FHEMB_SSH_USER }}
          FHEMB_SSH_HOST: ${{ vars.FHEMB_SSH_HOST }}
          FHEMB_ENV_DB: |
            DB_NAME=${{ vars.FHEMB_DB_NAME }}
            DB_USERNAME=${{ vars.FHEMB_DB_USER }}
            DB_PASSWORD=${{ secrets.FHEMB_DB_PASS }}
            DB_HOST=${{ vars.FHEMB_DB_HOST }}
            DB_PORT=${{ vars.FHEMB_DB_PORT }}
            REMOTE_HOST=${{ vars.FHEMB_SSH_HOST }}
            REMOTE_PORT=${{ vars.FHEMB_REMOTE_PORT }}
            SSH_USERNAME=${{ secrets.FHEMB_SSH_USER }}
            SSH_PKEY=/root/.ssh/id_rsa
            REMOTE_BIND_HOST=${{ vars.FHEMB_DB_HOST }}
            REMOTE_BIND_PORT=${{ vars.FHEMB_DB_PORT }}
          FHEMB_ENV_PATHS: |
            NODENAME=${{ vars.NODENAME }}
            LOCALROOT=${{ vars.FHEMB_LOCALRROT }}
            MOUNT=${{ vars.FHEMB_MOUNT }}
            AUDIOFILES=${{ vars.FHEMB_AUDIOFILES }}
        run: |
          echo "=== Starting Docker container ==="
          docker run \
            --network host \
            -v "$GITHUB_WORKSPACE:/workspace" \
            -e GITHUB_REPOSITORY \
            -e GITHUB_TOKEN \
            -e FHEMB_CI \
            -e FHEMB_SSH_KEY \
            -e FHEMB_SSH_USER \
            -e FHEMB_SSH_HOST \
            -e FHEMB_ENV_DB \
            -e FHEMB_ENV_PATHS \
            rdned/nbdev-fhemb:2.4.14 2>&1 | tee build.log
          echo "=== Docker container exited with code: $? ==="
      
      - name: Show build log
        if: always()
        run: |
          if [ -f build.log ]; then
            echo "=== Build Log ==="
            cat build.log
          fi

      - name: Show workspace state
        if: always()
        run: |
          echo "=== Workspace after build ==="
          ls -la $GITHUB_WORKSPACE/
          ls -la $GITHUB_WORKSPACE/_docs/ 2>/dev/null || echo "No _docs directory"

      - name: Cleanup
        if: always()
        run: |
          sudo chown -R $USER:$USER "$GITHUB_WORKSPACE" 2>/dev/null || true
          docker image prune -f --filter "until=1h" 2>/dev/null || true

