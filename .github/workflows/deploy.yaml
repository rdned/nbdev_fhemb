name: Deploy to GitHub Pages

permissions:
  contents: write
  pages: write
  id-token: write

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:

  # -------------------------------
  # JOB 0: HOST-SIDE PRE-CLEAN
  # -------------------------------
  preclean:
    runs-on: scienziatiello
    steps:
      - name: Pre-clean workspace on host
        run: chown -R 1000:1000 $GITHUB_WORKSPACE || true

      - uses: actions/checkout@v4


  # -------------------------------
  # JOB 1: BUILD DOCS (CONTAINER)
  # -------------------------------
  build:
    runs-on: scienziatiello
    needs: preclean

    container:
      image: python:3.12
      options: --user 1000:1000

    steps:
      - uses: actions/checkout@v4

      - name: Ensure neurolab user exists inside container
        run: |
          if ! id -u 1000 >/dev/null 2>&1; then
            groupadd -g 1000 neurolab || true
            useradd -m -u 1000 -g 1000 neurolab || true
          fi

      - name: Fix workspace permissions inside container
        run: chown -R 1000:1000 $GITHUB_WORKSPACE

      # ... all your container steps unchanged ...
      # (nbdev_test, nbdev_docs, SSH tunnel, Quarto, etc.)

      - name: Upload built docs as artifact
        uses: actions/upload-artifact@v4
        with:
          name: built-docs
          path: ${{ github.workspace }}/_docs


  # -------------------------------
  # JOB 2: DEPLOY
  # -------------------------------
  deploy:
    runs-on: scienziatiello
    needs: build

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/download-artifact@v4
        with:
          name: built-docs
          path: ./_docs

      - name: Prepare isolated deploy directory
        run: |
          mkdir deploy-root
          cp -r .git deploy-root/.git
          cp -r _docs deploy-root/_docs

      - name: Deploy inside isolated container
        run: |
          docker run --rm \
            -v "$PWD/deploy-root":/workspace \
            ubuntu:22.04 \
            bash -c "
              apt-get update &&
              apt-get install -y git ca-certificates &&
              cd /workspace &&
              git config user.name 'github-actions' &&
              git config user.email 'github-actions@github.com' &&
              git checkout gh-pages || git checkout --orphan gh-pages &&
              git rm -rf . || true &&
              cp -r _docs/* . &&
              rm -rf _docs &&
              git add . &&
              git commit -m 'Update docs' || echo 'No changes to commit' &&
              git push origin gh-pages
            "

