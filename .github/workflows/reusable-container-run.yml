name: Reusable - Container Run

on:
  workflow_call:
    inputs:
      fhemb_tag:
        required: true
        type: string
      ci_utils_commit:
        required: true
        type: string
      nbdev_fhemb_image:
        required: true
        type: string
      entrypoint:
        required: true
        type: string
    secrets:
      FHEMB_TOKEN:
        required: true
      FHEMB_CI_CLASSIC:
        required: true
      FHEMB_SSH_KEY:
        required: true
      FHEMB_SSH_USER:
        required: true
      FHEMB_DB_PASS:
        required: true

jobs:
  run:
    runs-on: scienziatiello

    steps:
      - name: Run container
        env:
          FHEMB_TAG: ${{ inputs.fhemb_tag }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GH_PAGES_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          FHEMB_TOKEN: ${{ secrets.FHEMB_TOKEN }}
          FHEMB_CI_CLASSIC: ${{ secrets.FHEMB_CI_CLASSIC }}
          FHEMB_SSH_KEY: ${{ secrets.FHEMB_SSH_KEY }}
          FHEMB_SSH_USER: ${{ secrets.FHEMB_SSH_USER }}
          FHEMB_SSH_HOST: ${{ vars.FHEMB_SSH_HOST }}

          FHEMB_ENV_DB: |
            DB_NAME=${{ vars.FHEMB_DB_NAME }}
            DB_USERNAME=${{ vars.FHEMB_DB_USER }}
            DB_PASSWORD=${{ secrets.FHEMB_DB_PASS }}
            DB_HOST=${{ vars.FHEMB_DB_HOST }}
            DB_PORT=${{ vars.FHEMB_DB_PORT }}
            REMOTE_HOST=${{ vars.FHEMB_SSH_HOST }}
            REMOTE_PORT=${{ vars.FHEMB_REMOTE_PORT }}
            SSH_USERNAME=${{ secrets.FHEMB_SSH_USER }}
            SSH_PKEY=/root/.ssh/id_rsa
            REMOTE_BIND_HOST=${{ vars.FHEMB_DB_HOST }}
            REMOTE_BIND_PORT=${{ vars.FHEMB_DB_PORT }}

          FHEMB_ENV_PATHS: |
            NODENAME=${{ vars.NODENAME }}
            LOCALROOT=${{ vars.FHEMB_LOCALROOT }}
            MOUNT=${{ vars.FHEMB_MOUNT }}
            AUDIOFILES=${{ vars.FHEMB_AUDIOFILES }}

          CI_UTILS_COMMIT: ${{ inputs.ci_utils_commit }}
          NBDEV_FHEMB_IMAGE: ${{ inputs.nbdev_fhemb_image }}

        run: |
          set -euo pipefail

          # Compute derived variables
          FHEMB_VERSION=${FHEMB_TAG#v}
          FHEMB_WHEEL="fhemb-${FHEMB_VERSION}-py3-none-any.whl"

          # Create envfile for single-line variables
          {
            printf 'HOME=/root\n'
            printf 'GITHUB_REPOSITORY=%s\n' "$GITHUB_REPOSITORY"
            printf 'GH_PAGES_TOKEN=%s\n' "$GH_PAGES_TOKEN"
            printf 'FHEMB_TOKEN=%s\n' "$FHEMB_TOKEN"
            printf 'FHEMB_CI_CLASSIC=%s\n' "$FHEMB_CI_CLASSIC"
            printf 'FHEMB_SSH_KEY=%s\n' "$FHEMB_SSH_KEY"
            printf 'FHEMB_SSH_USER=%s\n' "$FHEMB_SSH_USER"
            printf 'FHEMB_SSH_HOST=%s\n' "$FHEMB_SSH_HOST"
            printf 'FHEMB_TAG=%s\n' "$FHEMB_TAG"
            printf 'FHEMB_WHEEL=%s\n' "$FHEMB_WHEEL"
            printf 'CI_UTILS_COMMIT=%s\n' "$CI_UTILS_COMMIT"
          } > envfile

          # Run container (pass multi-line vars explicitly)
          docker run --rm \
            --network host \
            --env-file envfile \
            -e FHEMB_ENV_DB \
            -e FHEMB_ENV_PATHS \
            "$NBDEV_FHEMB_IMAGE" \
            ${{ inputs.entrypoint }}
